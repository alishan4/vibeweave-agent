name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Oracle via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/vibeweave-agent

            echo "Pull latest..."
            git fetch origin main
            git reset --hard origin/main

            echo "Install deps..."
            pnpm install --frozen-lockfile

            echo "Build..."
            pnpm build

            echo "Restart PM2..."
            pm2 start ecosystem.config.cjs --only vibeweave-agent || pm2 start ecosystem.config.cjs
            pm2 save

            echo "Done âœ…"
